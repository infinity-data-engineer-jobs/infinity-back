<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>∞</title>
    <!-- CSS 파일 -->
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <!-- JavaScript 파일 -->
    <script src="{% static 'js/common.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- D3.js 라이브러리 -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- d3-cloud 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.7/build/d3.layout.cloud.min.js"></script>
    
    <script>
        let noticeTechStack = [];
        let techStackCounts = {};
        let charts = [];
        const colorMap = {}; // 항목 이름별 색상 저장 객체

        function getRandomColor(label) {
            if (!colorMap[label]) {
                // 새로운 항목이면 색상 생성 및 저장
                const r = Math.floor(Math.random() * 256); // 0~255 사이의 랜덤 값
                const g = Math.floor(Math.random() * 256);
                const b = Math.floor(Math.random() * 256);
                colorMap[label] = `rgba(${r}, ${g}, ${b}, 0.5)`; // 투명도 0.5
            }
            return colorMap[label]; // 저장된 색상 반환
        }

        window.addEventListener("load", function () {
            const ctxBar = document.getElementById('myChart');
            const ctxDoughnut = document.getElementById('techStackChart');

            document.body.addEventListener('wheel', (e) => {
                console.log(e.deltaY);
                // if (e.srcElement.tagName === 'BODY') {
                    const mainContainer = document.querySelector('.mainContainer');
                    if (mainContainer) {
                        const currentScroll = mainContainer.scrollTop;
                        const scrollAmount = 1000; // 스크롤 이동량
                        console.log("move!");
                        if (e.deltaY > 0) {
                            // 아래로 스크롤
                            mainContainer.scrollTo({ top: currentScroll + scrollAmount, behavior: 'smooth' });
                        } else {
                            // 위로 스크롤
                            mainContainer.scrollTo({ top: currentScroll - scrollAmount, behavior: 'smooth' });
                        }
                    }
                // }
            });



            ajax_get("{% url 'noticeTechStack' %}", (data) => {
                noticeTechStack = data;

                // 회사 인원수 데이터 처리
                var headcountData = noticeTechStack.map(item => Math.floor(item.company_headcount / 100) * 100);
                var headcountLabels = [...new Set(headcountData)].sort((a, b) => a - b);
                var headcountCounts = headcountLabels.map(label => headcountData.filter(count => count === label).length);

                // 회사 연봉 데이터 처리 (평균 계산)
                const salaryData = headcountLabels.map(label => {
                    const filteredSalaries = noticeTechStack
                        .filter(item => Math.floor(item.company_headcount / 100) * 100 === label)
                        .map(item => parseFloat(item.company_salary) || 0); // 연봉이 없는 경우 0 처리
                    const totalSalary = filteredSalaries.reduce((sum, salary) => sum + salary, 0);
                    return filteredSalaries.length > 0 ? totalSalary / filteredSalaries.length : 0; // 평균 계산
                });

                // 기술 스택 데이터 처리 (줄바꿈 기준으로 분리)
                noticeTechStack.forEach(item => {
                    const techStacks = item.notice_tech_stack ? item.notice_tech_stack.split('\n') : [];
                    techStacks.forEach(stack => {
                        stack = stack.trim(); // 공백 제거
                        if (stack) {
                            techStackCounts[stack] = (techStackCounts[stack] || 0) + 1;
                        }
                    });
                });
                
                // 상위 20개의 기술 스택 추출 및 나머지 그룹화
                const sortedTechStacks = Object.entries(techStackCounts)
                    .sort((a, b) => b[1] - a[1]); // 값 기준으로 내림차순 정렬
                
                const top10TechStacks = sortedTechStacks.slice(0, 20); // 상위 10개 추출
                const othersTechStacks = sortedTechStacks.slice(20); // 나머지 추출

                const techStackLabels = top10TechStacks.map(item => item[0]); // 상위 10개의 기술 스택 이름
                const techStackData = top10TechStacks.map(item => item[1]);  // 상위 10개의 기술 스택 개수
                
                // 나머지 합산하여 "Others" 추가
                const othersCount = othersTechStacks.reduce((sum, item) => sum + item[1], 0);
                if (othersCount > 0) {
                    techStackLabels.push("Others");
                    techStackData.push(othersCount);
                }

                // 막대 차트 생성
                charts[0] = new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: headcountLabels,
                        datasets: [
                            {
                                label: '회사수',
                                data: headcountCounts,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '회사 입사자 평균 연봉',
                                data: salaryData,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                yAxisID: 'y1' // 별도의 Y축 사용
                            }
                        ]
                    },
                    options: {
                        scales: {
                            x: {
                                ticks: {
                                    callback: function (value, index, values) {
                                        // X축 라벨 커스텀
                                        return headcountLabels[index];
                                    }
                                },
                                title: {
                                    display: true,
                                    text: '인원수'
                                }
                            },
                            y: {
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '회사수'
                                }
                            },
                            y1: {
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '평균 연봉'
                                },
                                grid: {
                                    drawOnChartArea: false // 기존 Y축과 겹치지 않도록 설정
                                }
                            }
                        }
                    }
                });

                // 도넛 차트 생성
                charts[1] = new Chart(ctxDoughnut, {
                    type: 'doughnut',
                    data: {
                        labels: techStackLabels,
                        datasets: [{
                            label: '기술 스택별 공고 수',
                            data: techStackData,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(255, 159, 64, 0.2)',
                                'rgba(255, 99, 71, 0.2)',
                                'rgba(60, 179, 113, 0.2)',
                                'rgba(123, 104, 238, 0.2)',
                                'rgba(255, 215, 0, 0.2)',
                                'rgba(169, 169, 169, 0.2)',
                                'rgba(0, 128, 128, 0.2)',
                                'rgba(128, 0, 128, 0.2)',
                                'rgba(128, 128, 0, 0.2)',
                                'rgba(0, 255, 255, 0.2)',
                                'rgba(255, 20, 147, 0.2)',
                                'rgba(70, 130, 180, 0.2)',
                                'rgba(46, 139, 87, 0.2)',
                                'rgba(210, 105, 30, 0.2)',
                                'rgba(0, 191, 255, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(255, 99, 71, 1)',
                                'rgba(60, 179, 113, 1)',
                                'rgba(123, 104, 238, 1)',
                                'rgba(255, 215, 0, 1)',
                                'rgba(169, 169, 169, 1)',
                                'rgba(0, 128, 128, 1)',
                                'rgba(128, 0, 128, 1)',
                                'rgba(128, 128, 0, 1)',
                                'rgba(0, 255, 255, 1)',
                                'rgba(255, 20, 147, 1)',
                                'rgba(70, 130, 180, 1)',
                                'rgba(46, 139, 87, 1)',
                                'rgba(210, 105, 30, 1)',
                                'rgba(0, 191, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: '기술 스택별 공고 수 (상위 20개)'
                            }
                        }
                    }
                });

                charts[1].toggleDataVisibility(20)
                charts[1].update()
                const width = 500;
                const height = 300;

                const maxSize = Math.max(...top10TechStacks.map(item => item[1])); // 최대 크기
                const minFontSize = 10; // 최소 폰트 크기
                const maxFontSize = 50; // 최대 폰트 크기

                const layout = d3.layout.cloud()
                    .size([width, height])
                    .words(top10TechStacks.map(([key, value]) => ({
                        text: key,
                        size: (value / maxSize) * (maxFontSize - minFontSize) + minFontSize // 최소/최대 크기 설정
                    })))
                    .padding(1)
                    .rotate(() => [45, 135, 270][Math.floor(Math.random() * 3)]) // 45도, 135도, 270도 중 랜덤 선택
                    .fontSize(d => d.size)
                    .on("end", draw);

                layout.start();

                function draw(words) {
                    d3.select("#wordCloud")
                        .append("svg")
                        .attr("width", layout.size()[0])
                        .attr("height", layout.size()[1])
                        .append("g")
                        .attr("transform", `translate(${layout.size()[0] / 2},${layout.size()[1] / 2})`)
                        .selectAll("text")
                        .data(words)
                        .enter().append("text")
                        .style("font-size", d => `${d.size}px`)
                        .style("fill", () => `hsl(${Math.random() * 360}, 100%, 50%)`) // 랜덤 색상
                        .attr("text-anchor", "middle")
                        .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                        .text(d => d.text);
                }
                
                const ctxBubble = document.getElementById('bubbleChart');

                const colors = [
                    'rgba(255, 99, 132, 0.5)',  // 빨강
                    'rgba(54, 162, 235, 0.5)', // 파랑
                    'rgba(255, 206, 86, 0.5)', // 노랑
                    'rgba(75, 192, 192, 0.5)', // 청록
                    'rgba(153, 102, 255, 0.5)', // 보라
                    'rgba(255, 159, 64, 0.5)'  // 주황
                ];

                function getRandomColor(stackName) {
                    const hash = stackName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    const r = (hash * 137) % 256;
                    const g = (hash * 149) % 256;
                    const b = (hash * 163) % 256;
                    return `rgba(${r}, ${g}, ${b}, 0.5)`;
                }

                // 회사 규모와 매출 데이터를 10단위, 억 단위로 그룹화
                const groupedData = {};
                noticeTechStack.forEach(item => {
                    const sizeGroup = Math.floor((item.company_headcount || 0) / 10) * 10; // 인원수 10단위 그룹화
                    const revenueGroup = Math.floor((item.company_revenue || 0) / 100000000); // 매출 억 단위 그룹화
                    const techStacks = item.notice_tech_stack ? item.notice_tech_stack.split('\n') : [];

                    techStacks.forEach(stack => {
                        stack = stack.trim();
                        if (!stack) return;

                        const key = `${sizeGroup}-${revenueGroup}`;
                        if (!groupedData[key]) {
                            groupedData[key] = { size: sizeGroup, revenue: revenueGroup, techStacks: {} };
                        }
                        groupedData[key].techStacks[stack] = (groupedData[key].techStacks[stack] || 0) + 1;
                    });
                });

                // 버블 차트 데이터 생성
                const bubbleData = Object.values(groupedData).map(group => {
                    const topTechStack = Object.entries(group.techStacks).sort((a, b) => b[1] - a[1])[0] || ["None", 0];
                    const stackName = topTechStack[0];

                    return {
                        x: group.size || 0, // 회사 인원수
                        y: group.revenue || 0, // 회사 매출 (억 단위)
                        r: Math.sqrt(topTechStack[1] || 0) * 5, // 기술 스택 개수에 따라 버블 크기 조정
                        label: stackName, // 기술 스택 이름
                        backgroundColor: getRandomColor(stackName) // 항목 이름에 따른 색상
                    };
                });
                console.log("bubbleData:", bubbleData);

                // 버블 차트 생성
                charts[2] = new Chart(ctxBubble, {
                    type: 'bubble',
                    data: {
                        datasets: bubbleData.map(data => ({
                            label: data.label,
                            data: [data],
                            backgroundColor: data.backgroundColor,
                            borderColor: data.backgroundColor.replace('0.5', '1'), // 테두리 색상
                            borderWidth: 1
                        }))
                    },
                    options: {
                        plugins: {
                            legend: {
                                display: false // 범례 숨기기
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const data = context.raw;
                                        return `기술 스택: ${data.label}, 인원수: ${data.x}, 매출: ${data.y}, 공고 수: ${Math.round(data.r / 5) ** 2}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '회사 인원수 (10단위)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '회사 매출 (억 단위)'
                                }
                            }
                        }
                    }
                });
            
            document.querySelector('.page_lodding').style.display = 'none'; // 로딩 바 숨기기
            });
        });
</script>
</head>
<body>
    <section class="mainContainer">
        <div class="ChartContainer">
            <article>
                <h1 class="mainTitle">그래서 데이터 엔지니어가 뭔데?</h1><br>
                <p class="subTitle">데이터엔지니어? 저희가 알려드릴게요! 직접 데이터 확인해 볼까요?</p>
            </article>
        </div>
        <div class="ChartContainer">
            <article>
                <canvas id="myChart"></canvas>
            </article>
        </div>
        <div class="ChartContainer">
            <article>
                <canvas id="techStackChart"></canvas>
            </article>
        </div>
        <div class="ChartContainer">
            <article>
                <div id="wordCloud"></div>
            </article>
        </div>
        <div class="ChartContainer">
            <article>
                <canvas id="bubbleChart"></canvas>
            </article>
        </div>
        <div class="ChartContainer">
            <article>
                <h2 class="mainTitle">엔지니어가 어떤것인지 알게 되셧나요?</h1><br>
                <p class="subTitle">데이터엔지니어! 당신도 할수 있습니다!</p>
            </article>
        </div>
    </section>
</body>
<div class="page_lodding">
    <div class="spinner"></div>
</div>
</html>
